(()=>{var e={};e.id=9395,e.ids=[9395],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9348:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},412:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},8893:e=>{"use strict";e.exports=require("buffer")},4770:e=>{"use strict";e.exports=require("crypto")},6162:e=>{"use strict";e.exports=require("stream")},1764:e=>{"use strict";e.exports=require("util")},4772:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>p,serverHooks:()=>g,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{GET:()=>l,POST:()=>m});var n=r(2412),o=r(4293),i=r(4147),a=r(7856),u=r(4871);class c{static async uploadDocument(e){try{let t=await this.validateFile(e);if(!t.isValid)return{success:!1,documentId:"",validationStatus:"FAILED",requiresReview:!1,errors:t.errors};let r=await this.processDocumentContent(e),s=await u.db.studentDocument.create({data:{studentId:e.studentId,documentType:e.documentType,fileName:e.fileName,fileSizeBytes:e.fileSize,filePath:await this.saveFileToStorage(e),mimeType:e.mimeType,extractedText:r.extractedText,reviewStatus:r.autoApproval?"AUTO_APPROVED":"PENDING",autoValidationScore:r.score,requiresManualReview:r.requiresManualReview,versionNumber:await this.getNextVersionNumber(e.studentId,e.documentType),replacesDocumentId:e.metadata?.replacesDocumentId}});return r.autoApproval&&await this.updateDocumentProgress(e.studentId,e.documentType),await this.sendDocumentNotifications(s.id,e.studentId,r),{success:!0,documentId:s.id,validationStatus:r.autoApproval?"PASSED":"NEEDS_MANUAL_REVIEW",requiresReview:r.requiresManualReview,extractedText:r.extractedText,errors:r.errors}}catch(e){throw console.error("Error uploading document:",e),Error("Failed to upload document")}}static async validateFile(e){let t=[];return e.fileSize>0xa00000&&t.push("File size exceeds maximum limit of 10MB"),["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","image/jpeg","image/png"].includes(e.mimeType)||t.push("File type not supported. Please upload PDF, Word, or image files."),e.fileName.length>255&&t.push("File name is too long"),(await this.scanForVirus(e.fileBuffer)).isClean||t.push("File failed security scan"),{isValid:0===t.length,score:0===t.length?100:0,errors:t,warnings:[],extractedText:"",requiresManualReview:t.length>0,autoApproval:0===t.length}}static async processDocumentContent(e){try{let t=await this.extractText(e),r=await this.validateContent(t,e.documentType),s=this.calculateValidationScore(r),n=s<70||r.errors.length>0,o=s>=90&&0===r.errors.length;return{isValid:0===r.errors.length,score:s,errors:r.errors,warnings:r.warnings,extractedText:t,requiresManualReview:n,autoApproval:o}}catch(e){return console.error("Error processing document content:",e),{isValid:!1,score:0,errors:["Failed to process document content"],warnings:[],extractedText:"",requiresManualReview:!0,autoApproval:!1}}}static async extractText(e){return e.mimeType.startsWith("image/")?`Extracted text from ${e.fileName} - This is a mock OCR result. In production, this would contain the actual extracted text from the image.`:"application/pdf"===e.mimeType?`Extracted text from PDF ${e.fileName} - This is a mock PDF extraction result. In production, this would contain the actual text from the PDF.`:e.mimeType.includes("wordprocessingml")||"application/msword"===e.mimeType?`Extracted text from Word document ${e.fileName} - This is a mock Word extraction result. In production, this would contain the actual text from the Word document.`:e.fileBuffer.toString("utf-8")}static async validateContent(e,t){let r=[],s=[];switch((!e||e.trim().length<50)&&r.push("Document content is too short. Minimum 50 characters required."),e.length>5e4&&s.push("Document is very long. Consider breaking it into smaller sections."),t){case"CONSULTATION_LOG":e.toLowerCase().includes("consultation")||e.toLowerCase().includes("session")||r.push("Consultation log should contain information about consultation sessions.");break;case"EVALUATION_FORM":e.toLowerCase().includes("evaluation")||e.toLowerCase().includes("assessment")||r.push("Evaluation form should contain evaluation or assessment information.");break;case"REFLECTION_PAPER":e.toLowerCase().includes("reflection")||e.toLowerCase().includes("learning")||s.push("Reflection paper should contain personal reflections and learning insights.");break;case"CASE_STUDY":e.toLowerCase().includes("case")||e.toLowerCase().includes("client")||r.push("Case study should contain case or client information.")}let n=this.getRequiredKeywords(t).filter(t=>!e.toLowerCase().includes(t.toLowerCase()));return n.length>0&&s.push(`Consider including: ${n.join(", ")}`),{isValid:0===r.length,score:this.calculateContentScore(e,r,s),errors:r,warnings:s,extractedText:e,requiresManualReview:r.length>0||s.length>2,autoApproval:0===r.length&&s.length<=1}}static getRequiredKeywords(e){switch(e){case"CONSULTATION_LOG":return["consultation","session","client","progress","notes"];case"EVALUATION_FORM":return["evaluation","assessment","feedback","rating"];case"REFLECTION_PAPER":return["reflection","learning","experience","insight"];case"CASE_STUDY":return["case","client","intervention","outcome"];default:return[]}}static calculateValidationScore(e){let t;return t=100-20*e.errors.length-5*e.warnings.length,e.extractedText.length>500&&(t+=10),Math.max(0,Math.min(100,t))}static calculateContentScore(e,t,r){let s;return s=100-25*t.length-5*r.length,e.length>1e3&&(s+=10),(e.includes("\n\n")||e.includes("  "))&&(s+=5),Math.max(0,Math.min(100,s))}static async reviewDocument(e,t){try{if(await u.db.studentDocument.update({where:{id:e},data:{reviewStatus:t.status,reviewedBy:t.reviewerId,reviewedAt:t.reviewedAt,reviewNotes:t.notes}}),"APPROVED"===t.status){let t=await u.db.studentDocument.findUnique({where:{id:e}});t&&await this.updateDocumentProgress(t.studentId,t.documentType)}await this.sendReviewNotifications(e,t)}catch(e){throw console.error("Error reviewing document:",e),Error("Failed to review document")}}static async getStudentDocuments(e,t){try{let r={studentId:e};return t?.documentType&&t.documentType.length>0&&(r.documentType={in:t.documentType}),t?.reviewStatus&&t.reviewStatus.length>0&&(r.reviewStatus={in:t.reviewStatus}),await u.db.studentDocument.findMany({where:r,orderBy:{uploadTimestamp:"desc"},take:t?.limit||20,skip:t?.offset||0})}catch(e){throw console.error("Error getting student documents:",e),Error("Failed to get student documents")}}static async getDocumentRequirementsStatus(e){try{let t=await this.getStudentDocuments(e),r={consultationLog:{required:!0,submitted:!1,approved:!1},evaluationForm:{required:!0,submitted:!1,approved:!1},reflectionPaper:{required:!0,submitted:!1,approved:!1},caseStudy:{required:!0,submitted:!1,approved:!1},additionalRequirements:{required:!1,submitted:!1,approved:!1}};return t.forEach(e=>{let t=e.documentType.toLowerCase().replace("_","");r[t]&&(r[t].submitted=!0,r[t].approved="APPROVED"===e.reviewStatus)}),r}catch(e){throw console.error("Error getting document requirements status:",e),Error("Failed to get document requirements status")}}static async updateDocumentProgress(e,t){console.log(`Document progress updated for student ${e}, document type: ${t}`)}static async saveFileToStorage(e){let t=`${e.studentId}/${Date.now()}_${e.fileName}`;return`/uploads/${t}`}static async getNextVersionNumber(e,t){let r=await u.db.studentDocument.findMany({where:{studentId:e,documentType:t},orderBy:{versionNumber:"desc"},take:1});return r.length>0?r[0].versionNumber+1:1}static async scanForVirus(e){return{isClean:!0}}static async sendDocumentNotifications(e,t,r){console.log(`Document notifications sent for document ${e}`)}static async sendReviewNotifications(e,t){console.log(`Review notifications sent for document ${e}`)}}var d=r(8772);async function l(e){try{let t=await (0,d.ts)(e);if(!t)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),s=r.get("action");if("list"===s){let e=r.get("documentType")?.split(","),s=r.get("reviewStatus")?.split(","),n=parseInt(r.get("limit")||"20"),o=parseInt(r.get("offset")||"0"),i=await c.getStudentDocuments(t.id,{documentType:e,reviewStatus:s,limit:n,offset:o});return a.NextResponse.json({documents:i})}if("requirements"===s){let e=await c.getDocumentRequirementsStatus(t.id);return a.NextResponse.json({requirements:e})}return a.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return console.error("Documents API Error:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}async function m(e){try{let t=await (0,d.ts)(e);if(!t)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{action:r,...s}=await e.json();if("upload"===r){let{documentType:e,fileName:r,fileSize:n,mimeType:o,fileData:i,metadata:u}=s,d=Buffer.from(i,"base64"),l={studentId:t.id,documentType:e,fileName:r,fileSize:n,mimeType:o,fileBuffer:d,metadata:u},m=await c.uploadDocument(l);return a.NextResponse.json({result:m})}if("review"===r){let{documentId:e,status:r,notes:n,feedback:o}=s,i={reviewerId:t.id,status:r,notes:n,feedback:o,reviewedAt:new Date};return await c.reviewDocument(e,i),a.NextResponse.json({message:"Document reviewed successfully"})}return a.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return console.error("Documents API Error:",e),a.NextResponse.json({error:e instanceof Error?e.message:"Internal server error"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/documents/route",pathname:"/api/documents",filename:"route",bundlePath:"app/api/documents/route"},resolvedPagePath:"/Users/dgb_1011/Desktop/WeIn/WeIn/wein/src/app/api/documents/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:h,workUnitAsyncStorage:w,serverHooks:g}=p;function f(){return(0,i.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:w})}},5303:()=>{},8772:(e,t,r)=>{"use strict";r.d(t,{ts:()=>a});var s=r(3449),n=r.n(s),o=r(4871);let i=process.env.JWT_SECRET||"your-secret-key";async function a(e){try{let t=e.headers.get("authorization")?.replace("Bearer ","");if(!t)return null;let r=function(e){try{return n().verify(e,i)}catch(e){return null}}(t);if(!r)return null;return await o.db.user.findUnique({where:{id:r.userId},select:{id:!0,email:!0,firstName:!0,lastName:!0,userType:!0,status:!0}})}catch(e){return console.error("Auth middleware error:",e),null}}},4871:(e,t,r)=>{"use strict";r.d(t,{db:()=>n});var s=r(3524);let n=globalThis.prisma??new s.PrismaClient({log:["error"],datasources:{db:{url:process.env.DATABASE_URL}}});process.on("beforeExit",async()=>{await n.$disconnect()})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[3267,8814,3449],()=>r(4772));module.exports=s})();