(()=>{var e={};e.id=8846,e.ids=[8846],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9348:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},412:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},8893:e=>{"use strict";e.exports=require("buffer")},4770:e=>{"use strict";e.exports=require("crypto")},6162:e=>{"use strict";e.exports=require("stream")},1764:e=>{"use strict";e.exports=require("util")},553:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>y,routeModule:()=>f,serverHooks:()=>h,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>g});var i={};s.r(i),s.d(i,{GET:()=>c,POST:()=>m});var n=s(2412),r=s(4293),a=s(4147),o=s(7856),l=s(4871);class d{static async getConsultantAvailability(e,t,s=!1){try{let i=await l.db.consultantAvailability.findMany({where:{consultantId:e,isAvailable:!0,OR:[{specificDate:{gte:t.start,lte:t.end}},{availabilityType:"RECURRING_WEEKLY"}]},orderBy:[{dayOfWeek:"asc"},{startTime:"asc"}]}),n=[];for(let e of i){let s=this.generateTimeSlotsFromAvailability(e,t);n.push(...s)}if(s)for(let s of(await l.db.consultationSession.findMany({where:{consultantId:e,scheduledStart:{gte:t.start,lte:t.end}},select:{id:!0,scheduledStart:!0,scheduledEnd:!0,status:!0}})))n.filter(e=>this.slotsOverlap(e,{startTime:s.scheduledStart,endTime:s.scheduledEnd})).forEach(e=>{e.status="BOOKED",e.currentBookings++});let r=new Date;return n.filter(e=>e.startTime>r)}catch(e){throw console.error("Error fetching consultant availability:",e),Error("Failed to fetch consultant availability")}}static async addAvailabilitySlot(e,t){try{let s=await l.db.consultantAvailability.create({data:{consultantId:e,availabilityType:t.availabilityType,dayOfWeek:t.dayOfWeek,specificDate:t.specificDate,startTime:t.startTime,endTime:t.endTime,maxSessions:t.maxSessions,bufferMinutes:t.bufferMinutes,isAvailable:t.isAvailable,bookingWindowDays:t.bookingWindowDays,minimumNoticeHours:t.minimumNoticeHours,timezone:t.timezone,recurringPattern:t.recurringPattern}});return{id:s.id,consultantId:s.consultantId,availabilityType:s.availabilityType,dayOfWeek:s.dayOfWeek||void 0,specificDate:s.specificDate||void 0,startTime:s.startTime,endTime:s.endTime,maxSessions:s.maxSessions,bufferMinutes:s.bufferMinutes,isAvailable:s.isAvailable,bookingWindowDays:s.bookingWindowDays,minimumNoticeHours:s.minimumNoticeHours,timezone:s.timezone,recurringPattern:s.recurringPattern}}catch(e){throw console.error("Error adding availability slot:",e),Error("Failed to add availability slot")}}static async findAvailableSlots(e,t,s){try{let i=await l.db.consultant.findMany({where:{isActive:!0},include:{user:!0}}),n=[];for(let e of i){let i=await this.getConsultantAvailability(e.id,s,!0),r=this.filterSlotsByPreferences(i,t,e);n.push(...r)}return(await this.scoreSlots(n,e,t)).sort((e,t)=>t.score-e.score)}catch(e){throw console.error("Error finding available slots:",e),Error("Failed to find available slots")}}static async bookSession(e){try{let t=await this.checkBookingConflicts(e);if(t.length>0)throw Error(`Booking conflicts found: ${t.map(e=>e.message).join(", ")}`);let s=await l.db.consultationSession.create({data:{studentId:e.studentId,consultantId:e.consultantId,scheduledStart:e.startTime,scheduledEnd:e.endTime,status:"SCHEDULED",sessionType:e.sessionType,studentNotes:e.notes}}),i=await l.db.consultant.findUnique({where:{id:e.consultantId},include:{user:!0}});if(!i)throw Error("Consultant not found");let n=this.generateConfirmationCode(),r={bookingId:s.id,consultantId:s.consultantId,studentId:s.studentId,startTime:s.scheduledStart,endTime:s.scheduledEnd,duration:(s.scheduledEnd.getTime()-s.scheduledStart.getTime())/6e4,status:"CONFIRMED",confirmationCode:n,joinUrl:`/video/session/${s.id}`,consultantInfo:{id:i.id,name:`${i.user.firstName} ${i.user.lastName}`,email:i.user.email,specialties:i.specialties||[],rating:4.5,timezone:i.timezone||"UTC"}};return await this.sendBookingNotifications(r),r}catch(e){throw console.error("Error booking session:",e),Error("Failed to book session")}}static async rescheduleSession(e,t,s,i){try{let n=await l.db.consultationSession.findUnique({where:{id:e},include:{consultant:{include:{user:!0}},student:{include:{user:!0}}}});if(!n)throw Error("Session not found");let r=await this.checkBookingConflicts({studentId:n.studentId,consultantId:n.consultantId,startTime:t,endTime:s,sessionType:n.sessionType});if(r.length>0)throw Error(`Rescheduling conflicts found: ${r.map(e=>e.message).join(", ")}`);let a=await l.db.consultationSession.update({where:{id:e},data:{scheduledStart:t,scheduledEnd:s,status:"RESCHEDULED",studentNotes:i?`${n.studentNotes||""}
Rescheduled: ${i}`:n.studentNotes}}),o={bookingId:a.id,consultantId:a.consultantId,studentId:a.studentId,startTime:a.scheduledStart,endTime:a.scheduledEnd,duration:(a.scheduledEnd.getTime()-a.scheduledStart.getTime())/6e4,status:"RESCHEDULED",confirmationCode:this.generateConfirmationCode(),joinUrl:`/video/session/${a.id}`,consultantInfo:{id:n.consultant.id,name:`${n.consultant.user.firstName} ${n.consultant.user.lastName}`,email:n.consultant.user.email,specialties:n.consultant.specialties||[],rating:4.5,timezone:n.consultant.timezone||"UTC"}};return await this.sendReschedulingNotifications(o,i),o}catch(e){throw console.error("Error rescheduling session:",e),Error("Failed to reschedule session")}}static async cancelSession(e,t){try{let s=await l.db.consultationSession.findUnique({where:{id:e},include:{consultant:{include:{user:!0}},student:{include:{user:!0}}}});if(!s)throw Error("Session not found");await l.db.consultationSession.update({where:{id:e},data:{status:"CANCELLED",studentNotes:t?`${s.studentNotes||""}
Cancelled: ${t}`:s.studentNotes}}),await this.sendCancellationNotifications(s,t)}catch(e){throw console.error("Error cancelling session:",e),Error("Failed to cancel session")}}static async checkBookingConflicts(e){let t=[];(await l.db.consultationSession.findMany({where:{consultantId:e.consultantId,status:{in:["SCHEDULED","CONFIRMED"]},OR:[{scheduledStart:{lt:e.endTime},scheduledEnd:{gt:e.startTime}}]}})).length>0&&t.push({type:"DOUBLE_BOOKING",message:"Consultant is already booked for this time slot"});let s=new Date,i=(e.startTime.getTime()-s.getTime())/36e5;return await l.db.consultant.findUnique({where:{id:e.consultantId}})&&i<24&&t.push({type:"MINIMUM_NOTICE",message:"Booking must be made at least 24 hours in advance"}),t}static generateTimeSlotsFromAvailability(e,t){let s=[],i=new Date(t.start);for(;i<=t.end;){if("RECURRING_WEEKLY"===e.availabilityType){if(e.dayOfWeek===i.getDay()){let t=this.createTimeSlotFromAvailability(e,i);s.push(t)}}else if("ONE_TIME"===e.availabilityType&&e.specificDate&&e.specificDate.toDateString()===i.toDateString()){let t=this.createTimeSlotFromAvailability(e,i);s.push(t)}i.setDate(i.getDate()+1)}return s}static createTimeSlotFromAvailability(e,t){let[s,i]=e.startTime.split(":").map(Number),[n,r]=e.endTime.split(":").map(Number),a=new Date(t);a.setHours(s,i,0,0);let o=new Date(t);o.setHours(n,r,0,0);let l=(o.getTime()-a.getTime())/6e4;return{id:`slot_${e.id}_${t.getTime()}`,consultantId:e.consultantId,startTime:a,endTime:o,duration:l,status:"AVAILABLE",isRecurring:"RECURRING_WEEKLY"===e.availabilityType,dayOfWeek:e.dayOfWeek,timezone:e.timezone,maxSessions:e.maxSessions,currentBookings:0}}static slotsOverlap(e,t){return e.startTime<t.endTime&&e.endTime>t.startTime}static filterSlotsByPreferences(e,t,s){return e.filter(e=>{if(t.preferredDuration&&e.duration!==t.preferredDuration)return!1;let s=e.startTime.toTimeString().slice(0,5);return!(t.avoidTimes&&t.avoidTimes.includes(s))})}static async scoreSlots(e,t,s){return await Promise.all(e.map(async e=>{let t=100;s.preferredConsultants?.includes(e.consultantId)&&(t+=20);let i=e.startTime.toTimeString().slice(0,5);s.preferredTimeSlots?.includes(i)&&(t+=15),t+=(e.maxSessions-e.currentBookings)*5;let n=(e.startTime.getTime()-new Date().getTime())/36e5;return n>24&&n<168&&(t+=10),{...e,score:t}}))}static generateConfirmationCode(){return Math.random().toString(36).substring(2,8).toUpperCase()}static async sendBookingNotifications(e){console.log("Sending booking notifications for:",e.bookingId)}static async sendReschedulingNotifications(e,t){console.log("Sending rescheduling notifications for:",e.bookingId)}static async sendCancellationNotifications(e,t){console.log("Sending cancellation notifications for:",e.id)}}var u=s(8772);async function c(e){try{let t=await (0,u.ts)(e);if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:s}=new URL(e.url),i=s.get("action");if("availability"===i){let e=s.get("consultantId"),t=s.get("startDate"),i=s.get("endDate"),n="true"===s.get("includeBooked");if(!e||!t||!i)return o.NextResponse.json({error:"Missing required parameters"},{status:400});let r=await d.getConsultantAvailability(e,{start:new Date(t),end:new Date(i)},n);return o.NextResponse.json({availability:r})}if("availableSlots"===i){let e=s.get("startDate"),i=s.get("endDate"),n=parseInt(s.get("preferredDuration")||"60"),r=s.get("preferredTimeSlots")?.split(",")||[],a=s.get("avoidTimes")?.split(",")||[],l=s.get("preferredConsultants")?.split(",")||[];if(!e||!i)return o.NextResponse.json({error:"Missing required parameters"},{status:400});let u=await d.findAvailableSlots(t.id,{preferredDuration:n,preferredTimeSlots:r,avoidTimes:a,preferredConsultants:l},{start:new Date(e),end:new Date(i)});return o.NextResponse.json({slots:u})}return o.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return console.error("Scheduling API Error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function m(e){try{let t=await (0,u.ts)(e);if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{action:s,...i}=await e.json();if("addAvailability"===s){if("CONSULTANT"!==t.userType)return o.NextResponse.json({error:"Only consultants can add availability"},{status:403});let e=await d.addAvailabilitySlot(t.id,i);return o.NextResponse.json({slot:e})}if("bookSession"===s){if("STUDENT"!==t.userType)return o.NextResponse.json({error:"Only students can book sessions"},{status:403});let e={...i,studentId:t.id},s=await d.bookSession(e);return o.NextResponse.json({confirmation:s})}if("rescheduleSession"===s){let{sessionId:e,newStartTime:t,newEndTime:s,reason:n}=i,r=await d.rescheduleSession(e,new Date(t),new Date(s),n);return o.NextResponse.json({confirmation:r})}if("cancelSession"===s){let{sessionId:e,reason:t}=i;return await d.cancelSession(e,t),o.NextResponse.json({message:"Session cancelled successfully"})}return o.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return console.error("Scheduling API Error:",e),o.NextResponse.json({error:e instanceof Error?e.message:"Internal server error"},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/scheduling/route",pathname:"/api/scheduling",filename:"route",bundlePath:"app/api/scheduling/route"},resolvedPagePath:"/Users/dgb_1011/Desktop/WeIn/WeIn/wein/src/app/api/scheduling/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:p,workUnitAsyncStorage:g,serverHooks:h}=f;function y(){return(0,a.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:g})}},5303:()=>{},8772:(e,t,s)=>{"use strict";s.d(t,{ts:()=>o});var i=s(3449),n=s.n(i),r=s(4871);let a=process.env.JWT_SECRET||"your-secret-key";async function o(e){try{let t=e.headers.get("authorization")?.replace("Bearer ","");if(!t)return null;let s=function(e){try{return n().verify(e,a)}catch(e){return null}}(t);if(!s)return null;return await r.db.user.findUnique({where:{id:s.userId},select:{id:!0,email:!0,firstName:!0,lastName:!0,userType:!0,status:!0}})}catch(e){return console.error("Auth middleware error:",e),null}}},4871:(e,t,s)=>{"use strict";s.d(t,{db:()=>n});var i=s(3524);let n=globalThis.prisma??new i.PrismaClient({log:["error"],datasources:{db:{url:process.env.DATABASE_URL}}});process.on("beforeExit",async()=>{await n.$disconnect()})}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),i=t.X(0,[3267,8814,3449],()=>s(553));module.exports=i})();