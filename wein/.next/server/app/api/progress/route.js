(()=>{var e={};e.id=153,e.ids=[153],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9348:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},412:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},8893:e=>{"use strict";e.exports=require("buffer")},4770:e=>{"use strict";e.exports=require("crypto")},6162:e=>{"use strict";e.exports=require("stream")},1764:e=>{"use strict";e.exports=require("util")},1898:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>m,routeModule:()=>h,serverHooks:()=>E,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>S});var r={};s.r(r),s.d(r,{GET:()=>d,POST:()=>g});var a=s(2412),n=s(4293),o=s(4147),i=s(7856),l=s(4871);class u{static async getStudentProgress(e,t){try{let s=await this.getStudentSessions(e,t),r=s.filter(e=>"COMPLETED"===e.status&&e.studentVerifiedAt&&e.consultantVerifiedAt),a=r.reduce((e,t)=>e+this.calculateSessionDuration(t),0),n=s.filter(e=>"SCHEDULED"===e.status||"IN_PROGRESS"===e.status).reduce((e,t)=>{let s=(t.scheduledEnd.getTime()-t.scheduledStart.getTime())/36e5;return e+s},0),o=this.calculateWeeklyAverage(r),i=Math.ceil((40-a)/o),l=a+o*i,u=Math.min(a/40*100,100),c=Math.max(40-a,0),d=this.calculateEstimatedCompletion(a,o,r),g=this.calculateWeeklyProgress(r),h=this.calculateMilestoneStatus(a,r),p=this.calculateConsultantDistribution(r),S=this.formatSessionHistory(s),E=this.calculateCurrentStreak(r),m=this.calculateAverageSessionLength(r),R=r.length>0?new Date(Math.max(...r.map(e=>e.actualEnd?.getTime()||0))):null,D=this.getNextMilestone(a,o);return{studentId:e,totalVerifiedHours:a,totalPendingHours:n,totalProjectedHours:l,completionPercentage:u,remainingHours:c,estimatedCompletionDate:d,weeklyProgress:g,milestoneStatus:h,consultantDistribution:p,sessionHistory:S,currentStreak:E,averageSessionLength:m,lastSessionDate:R,nextMilestone:D}}catch(e){throw console.error("Error calculating student progress:",e),Error("Failed to calculate student progress")}}static async getStudentSessions(e,t){let s={studentId:e};return t?.dateRange&&(s.scheduledStart={gte:t.dateRange.start,lte:t.dateRange.end}),t?.consultantId&&(s.consultantId=t.consultantId),t?.status&&t.status.length>0&&(s.status={in:t.status}),await l.db.consultationSession.findMany({where:s,include:{consultant:{include:{user:!0}}},orderBy:{scheduledStart:"desc"}})}static calculateSessionDuration(e){return e.actualStart&&e.actualEnd?(e.actualEnd.getTime()-e.actualStart.getTime())/36e5:(e.scheduledDuration||60)/60}static calculateWeeklyAverage(e){if(0===e.length)return 2;let t=e.reduce((e,t)=>e+this.calculateSessionDuration(t),0),s=e[e.length-1];return t/Math.max(1,(e[0].actualEnd.getTime()-s.actualStart.getTime())/6048e5)}static calculateEstimatedCompletion(e,t,s){if(e>=40)return new Date;let r=Math.ceil((40-e)/t);if(0===s.length){let e=Math.ceil(20),t=new Date;return t.setDate(t.getDate()+7*e),t}let a=s[0],n=new Date(a.actualEnd||a.scheduledEnd);return n.setDate(n.getDate()+7*r),n}static calculateWeeklyProgress(e){if(0===e.length)return[];let t=new Map;e.forEach(e=>{let s=new Date(e.actualEnd||e.scheduledEnd),r=this.getWeekStart(s),a=r.toISOString();t.has(a)||t.set(a,{weekStart:r,weekEnd:new Date(r.getTime()+5184e5),hoursCompleted:0,sessionsCompleted:0,averageRating:0,trend:"stable"});let n=t.get(a);n.hoursCompleted+=this.calculateSessionDuration(e),n.sessionsCompleted+=1,e.rating&&(n.averageRating=(n.averageRating*(n.sessionsCompleted-1)+e.rating)/n.sessionsCompleted)});let s=Array.from(t.values()).sort((e,t)=>e.weekStart.getTime()-t.weekStart.getTime());for(let e=1;e<s.length;e++){let t=s[e],r=s[e-1];t.hoursCompleted>r.hoursCompleted?t.trend="increasing":t.hoursCompleted<r.hoursCompleted&&(t.trend="decreasing")}return s.slice(-12)}static calculateMilestoneStatus(e,t){return[{type:"FIRST_SESSION",status:t.length>0?"MILESTONE_REACHED":"NOT_STARTED",achievedAt:t.length>0?t[t.length-1].actualEnd:null,description:"Complete your first consultation session",icon:"\uD83C\uDFAF",color:"blue"},{type:"TEN_HOURS",status:e>=10?"MILESTONE_REACHED":e>0?"IN_PROGRESS":"NOT_STARTED",achievedAt:e>=10?this.getMilestoneAchievementDate(t,10):null,description:"Complete 10 hours of consultation",icon:"⭐",color:"green"},{type:"TWENTY_HOURS",status:e>=20?"MILESTONE_REACHED":e>10?"IN_PROGRESS":"NOT_STARTED",achievedAt:e>=20?this.getMilestoneAchievementDate(t,20):null,description:"Complete 20 hours of consultation",icon:"\uD83C\uDFC6",color:"purple"},{type:"THIRTY_HOURS",status:e>=30?"MILESTONE_REACHED":e>20?"IN_PROGRESS":"NOT_STARTED",achievedAt:e>=30?this.getMilestoneAchievementDate(t,30):null,description:"Complete 30 hours of consultation",icon:"\uD83D\uDC51",color:"orange"},{type:"FORTY_HOURS",status:e>=40?"MILESTONE_REACHED":e>30?"IN_PROGRESS":"NOT_STARTED",achievedAt:e>=40?this.getMilestoneAchievementDate(t,40):null,description:"Complete 40 hours of consultation",icon:"\uD83C\uDF89",color:"red"},{type:"CERTIFICATION_READY",status:e>=40?"MILESTONE_REACHED":e>35?"IN_PROGRESS":"NOT_STARTED",achievedAt:e>=40?this.getMilestoneAchievementDate(t,40):null,description:"Ready for certification",icon:"\uD83D\uDCDC",color:"gold"}]}static calculateConsultantDistribution(e){let t=new Map;e.forEach(e=>{let s=e.consultantId,r=`${e.consultant.user.firstName} ${e.consultant.user.lastName}`;t.has(s)||t.set(s,{consultantId:s,consultantName:r,sessionsCount:0,totalHours:0,averageRating:0,lastSessionDate:new Date(0),percentage:0});let a=t.get(s);a.sessionsCount+=1,a.totalHours+=this.calculateSessionDuration(e),e.rating&&(a.averageRating=(a.averageRating*(a.sessionsCount-1)+e.rating)/a.sessionsCount);let n=new Date(e.actualEnd||e.scheduledEnd);n>a.lastSessionDate&&(a.lastSessionDate=n)});let s=e.reduce((e,t)=>e+this.calculateSessionDuration(t),0);return Array.from(t.values()).map(e=>({...e,percentage:s>0?e.totalHours/s*100:0})).sort((e,t)=>t.totalHours-e.totalHours)}static formatSessionHistory(e){return e.map(e=>({id:e.id,date:new Date(e.actualEnd||e.scheduledEnd),duration:this.calculateSessionDuration(e),consultantName:`${e.consultant.user.firstName} ${e.consultant.user.lastName}`,status:e.status,rating:e.rating||void 0,notes:e.studentNotes||void 0}))}static calculateCurrentStreak(e){if(0===e.length)return 0;let t=e.sort((e,t)=>new Date(t.actualEnd||t.scheduledEnd).getTime()-new Date(e.actualEnd||e.scheduledEnd).getTime()),s=0,r=new Date(new Date().getTime()-6048e5);for(let e of t)if(new Date(e.actualEnd||e.scheduledEnd)>=r)s++;else break;return s}static calculateAverageSessionLength(e){return 0===e.length?60:e.reduce((e,t)=>e+this.calculateSessionDuration(t),0)/e.length*60}static getNextMilestone(e,t){let s=[{type:"FIRST_SESSION",hoursRequired:0,description:"First Session",icon:"\uD83C\uDFAF",color:"blue"},{type:"TEN_HOURS",hoursRequired:10,description:"10 Hours",icon:"⭐",color:"green"},{type:"TWENTY_HOURS",hoursRequired:20,description:"20 Hours",icon:"\uD83C\uDFC6",color:"purple"},{type:"THIRTY_HOURS",hoursRequired:30,description:"30 Hours",icon:"\uD83D\uDC51",color:"orange"},{type:"FORTY_HOURS",hoursRequired:40,description:"40 Hours",icon:"\uD83C\uDF89",color:"red"}].find(t=>t.hoursRequired>e);if(!s)return null;let r=s.hoursRequired-e,a=Math.ceil(r/t),n=new Date;return n.setDate(n.getDate()+7*a),{...s,hoursRemaining:r,estimatedDate:n}}static getWeekStart(e){let t=new Date(e),s=t.getDay(),r=t.getDate()-s+(0===s?-6:1);return new Date(t.setDate(r))}static getMilestoneAchievementDate(e,t){let s=0;for(let r of e)if((s+=this.calculateSessionDuration(r))>=t)return new Date(r.actualEnd||r.scheduledEnd);return null}static async updateProgress(e){return await this.getStudentProgress(e)}static async getProgressAnalytics(e,t){let s=await this.getStudentProgress(e,{dateRange:t});return{totalSessions:s.sessionHistory.length,averageSessionLength:s.averageSessionLength,completionRate:s.completionPercentage,weeklyAverage:s.weeklyProgress.length>0?s.weeklyProgress.reduce((e,t)=>e+t.hoursCompleted,0)/s.weeklyProgress.length:0,consultantCount:s.consultantDistribution.length,currentStreak:s.currentStreak,estimatedCompletion:s.estimatedCompletionDate}}static async getMilestoneProgress(e){return(await this.getStudentProgress(e)).milestoneStatus}static async getWeeklyProgress(e,t=12){return(await this.getStudentProgress(e)).weeklyProgress.slice(-t)}}var c=s(8772);async function d(e){try{let t=await (0,c.ts)(e);if(!t)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:s}=new URL(e.url),r=s.get("action");if("overview"===r){let e=await u.getStudentProgress(t.id);return i.NextResponse.json({progress:e})}if("analytics"===r){let e=s.get("startDate"),r=s.get("endDate"),a=e&&r?{start:new Date(e),end:new Date(r)}:void 0,n=await u.getProgressAnalytics(t.id,a);return i.NextResponse.json({analytics:n})}if("milestones"===r){let e=await u.getMilestoneProgress(t.id);return i.NextResponse.json({milestones:e})}if("weekly"===r){let e=parseInt(s.get("weeks")||"12"),r=await u.getWeeklyProgress(t.id,e);return i.NextResponse.json({weeklyProgress:r})}if("sessionHistory"===r){let e=parseInt(s.get("limit")||"20"),r=parseInt(s.get("offset")||"0"),a=s.get("status")?.split(","),n=(await u.getStudentProgress(t.id,{includePending:!0})).sessionHistory;a&&a.length>0&&(n=n.filter(e=>a.includes(e.status)));let o=n.slice(r,r+e);return i.NextResponse.json({sessions:o,total:n.length,hasMore:r+e<n.length})}return i.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return console.error("Progress API Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function g(e){try{let t=await (0,c.ts)(e);if(!t)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{action:s}=await e.json();if("updateProgress"===s){let e=await u.updateProgress(t.id);return i.NextResponse.json({progress:e})}return i.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return console.error("Progress API Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/progress/route",pathname:"/api/progress",filename:"route",bundlePath:"app/api/progress/route"},resolvedPagePath:"/Users/dgb_1011/Desktop/WeIn/WeIn/wein/src/app/api/progress/route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:p,workUnitAsyncStorage:S,serverHooks:E}=h;function m(){return(0,o.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:S})}},5303:()=>{},8772:(e,t,s)=>{"use strict";s.d(t,{ts:()=>i});var r=s(3449),a=s.n(r),n=s(4871);let o=process.env.JWT_SECRET||"your-secret-key";async function i(e){try{let t=e.headers.get("authorization")?.replace("Bearer ","");if(!t)return null;let s=function(e){try{return a().verify(e,o)}catch(e){return null}}(t);if(!s)return null;return await n.db.user.findUnique({where:{id:s.userId},select:{id:!0,email:!0,firstName:!0,lastName:!0,userType:!0,status:!0}})}catch(e){return console.error("Auth middleware error:",e),null}}},4871:(e,t,s)=>{"use strict";s.d(t,{db:()=>a});var r=s(3524);let a=globalThis.prisma??new r.PrismaClient}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[267,814,449],()=>s(1898));module.exports=r})();